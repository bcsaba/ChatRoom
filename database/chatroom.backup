--
-- PostgreSQL database dump
--

-- Dumped from database version 14.2 (Debian 14.2-1)
-- Dumped by pg_dump version 14.2 (Debian 14.2-1)

-- Started on 2022-02-17 12:27:55 CET

SET statement_timeout = 0;
SET lock_timeout = 0;
SET idle_in_transaction_session_timeout = 0;
SET client_encoding = 'UTF8';
SET standard_conforming_strings = on;
SELECT pg_catalog.set_config('search_path', '', false);
SET check_function_bodies = false;
SET xmloption = content;
SET client_min_messages = warning;
SET row_security = off;

--
-- TOC entry 4027 (class 1262 OID 16395)
-- Name: chatroom; Type: DATABASE; Schema: -; Owner: chatroom1
--

CREATE DATABASE chatroom WITH TEMPLATE = template0 ENCODING = 'UTF8' LOCALE = 'en_GB.UTF-8';


ALTER DATABASE chatroom OWNER TO chatroom1;

\connect chatroom

SET statement_timeout = 0;
SET lock_timeout = 0;
SET idle_in_transaction_session_timeout = 0;
SET client_encoding = 'UTF8';
SET standard_conforming_strings = on;
SELECT pg_catalog.set_config('search_path', '', false);
SET check_function_bodies = false;
SET xmloption = content;
SET client_min_messages = warning;
SET row_security = off;

--
-- TOC entry 221 (class 1255 OID 16733)
-- Name: getHourlyChatRoomDataProc(); Type: PROCEDURE; Schema: public; Owner: postgres
--

CREATE PROCEDURE public."getHourlyChatRoomDataProc"()
    LANGUAGE sql
    AS $$
SELECT 
		e."EventTypeId" as "EventTypeId", 
		et."Name" as "Name", 
		count(*) as "CountType",
		count(distinct "UserId") as "UserInAction",
		count(distinct "TargetUserId") as "TargetUser",
		date_trunc('hour', "EventTime") as "HourPart"
	FROM public."RoomEvents" e
	inner join "RoomEventTypes" as et on e."EventTypeId" = et."Id"  
	group by "HourPart", e."EventTypeId", et."Name";
$$;


ALTER PROCEDURE public."getHourlyChatRoomDataProc"() OWNER TO postgres;

--
-- TOC entry 220 (class 1255 OID 16665)
-- Name: gethourlychatroomdata(); Type: PROCEDURE; Schema: public; Owner: postgres
--

CREATE PROCEDURE public.gethourlychatroomdata()
    LANGUAGE plpgsql
    AS $$
begin
    SELECT "EventTypeId", et."Name", count(*), count(distinct "UserId") as "UserInAction", count(distinct "TargetUserId") as "TargetUSer", date_trunc('hour', "EventTime") as "HourPart"
	FROM public."RoomEvents" e
	inner join "RoomEventTypes" as et on e."EventTypeId" = et."Id"  
	group by "HourPart", "EventTypeId", et."Name";
end;$$;


ALTER PROCEDURE public.gethourlychatroomdata() OWNER TO postgres;

--
-- TOC entry 233 (class 1255 OID 16740)
-- Name: gethourlychatroomdatafunc(integer); Type: FUNCTION; Schema: public; Owner: chatroom1
--

CREATE FUNCTION public.gethourlychatroomdatafunc(chatroomid integer) RETURNS TABLE(eventtypeid integer, "Name" text, counttype bigint, userinaction bigint, targetuser bigint, hourpart timestamp with time zone)
    LANGUAGE plpgsql
    AS $$
begin
	return query
	SELECT 
		e."EventTypeId"  as "EventTypeId", 
		et."Name" as "Name", 
		count(*) as "CountType",
		count(distinct "UserId") as "UserInAction",
		count(distinct "TargetUserId") as "TargetUser",
		date_trunc('hour', "EventTime") as "HourPart"
	FROM public."RoomEvents" e
	inner join "RoomEventTypes" as et on e."EventTypeId" = et."Id"  
	where e."ChatRoomId" = chatRoomId
	group by "HourPart", e."EventTypeId", et."Name";
end
$$;


ALTER FUNCTION public.gethourlychatroomdatafunc(chatroomid integer) OWNER TO chatroom1;

SET default_tablespace = '';

SET default_table_access_method = heap;

--
-- TOC entry 211 (class 1259 OID 16403)
-- Name: Users; Type: TABLE; Schema: public; Owner: chatroom1
--

CREATE TABLE public."Users" (
    "Id" integer NOT NULL,
    "NickNAme" text NOT NULL,
    "FirstName" text DEFAULT ''::text NOT NULL,
    "LastName" text DEFAULT ''::text NOT NULL
);


ALTER TABLE public."Users" OWNER TO chatroom1;

--
-- TOC entry 210 (class 1259 OID 16402)
-- Name: Blogs_BlogId_seq; Type: SEQUENCE; Schema: public; Owner: chatroom1
--

ALTER TABLE public."Users" ALTER COLUMN "Id" ADD GENERATED BY DEFAULT AS IDENTITY (
    SEQUENCE NAME public."Blogs_BlogId_seq"
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1
);


--
-- TOC entry 213 (class 1259 OID 16411)
-- Name: ChatRooms; Type: TABLE; Schema: public; Owner: chatroom1
--

CREATE TABLE public."ChatRooms" (
    "Id" integer NOT NULL,
    "Name" text NOT NULL,
    "CreatedById" integer DEFAULT 0 NOT NULL,
    "CreationTime" timestamp with time zone DEFAULT '-infinity'::timestamp with time zone NOT NULL
);


ALTER TABLE public."ChatRooms" OWNER TO chatroom1;

--
-- TOC entry 212 (class 1259 OID 16410)
-- Name: ChatRooms_ChatRoomId_seq; Type: SEQUENCE; Schema: public; Owner: chatroom1
--

ALTER TABLE public."ChatRooms" ALTER COLUMN "Id" ADD GENERATED BY DEFAULT AS IDENTITY (
    SEQUENCE NAME public."ChatRooms_ChatRoomId_seq"
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1
);


--
-- TOC entry 219 (class 1259 OID 16640)
-- Name: Comments; Type: TABLE; Schema: public; Owner: chatroom1
--

CREATE TABLE public."Comments" (
    "Id" integer NOT NULL,
    "CommentString" text NOT NULL,
    "ChatRoomId" integer NOT NULL,
    "PostingUser" integer NOT NULL,
    "PostEvent" integer NOT NULL
);


ALTER TABLE public."Comments" OWNER TO chatroom1;

--
-- TOC entry 218 (class 1259 OID 16639)
-- Name: Comments_Id_seq; Type: SEQUENCE; Schema: public; Owner: chatroom1
--

ALTER TABLE public."Comments" ALTER COLUMN "Id" ADD GENERATED BY DEFAULT AS IDENTITY (
    SEQUENCE NAME public."Comments_Id_seq"
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1
);


--
-- TOC entry 215 (class 1259 OID 16419)
-- Name: RoomEventTypes; Type: TABLE; Schema: public; Owner: chatroom1
--

CREATE TABLE public."RoomEventTypes" (
    "Id" integer NOT NULL,
    "Name" text NOT NULL
);


ALTER TABLE public."RoomEventTypes" OWNER TO chatroom1;

--
-- TOC entry 214 (class 1259 OID 16418)
-- Name: RoomEventTypes_RoomEventTypeId_seq; Type: SEQUENCE; Schema: public; Owner: chatroom1
--

ALTER TABLE public."RoomEventTypes" ALTER COLUMN "Id" ADD GENERATED BY DEFAULT AS IDENTITY (
    SEQUENCE NAME public."RoomEventTypes_RoomEventTypeId_seq"
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1
);


--
-- TOC entry 216 (class 1259 OID 16440)
-- Name: RoomEvents; Type: TABLE; Schema: public; Owner: chatroom1
--

CREATE TABLE public."RoomEvents" (
    "EventTypeId" integer NOT NULL,
    "UserId" integer NOT NULL,
    "TargetUserId" integer,
    "ChatRoomId" integer DEFAULT 0 NOT NULL,
    "Id" integer NOT NULL,
    "EventTime" timestamp with time zone DEFAULT '-infinity'::timestamp with time zone NOT NULL
);


ALTER TABLE public."RoomEvents" OWNER TO chatroom1;

--
-- TOC entry 217 (class 1259 OID 16577)
-- Name: RoomEvents_Id_seq; Type: SEQUENCE; Schema: public; Owner: chatroom1
--

ALTER TABLE public."RoomEvents" ALTER COLUMN "Id" ADD GENERATED BY DEFAULT AS IDENTITY (
    SEQUENCE NAME public."RoomEvents_Id_seq"
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1
);


--
-- TOC entry 209 (class 1259 OID 16397)
-- Name: __EFMigrationsHistory; Type: TABLE; Schema: public; Owner: chatroom1
--

CREATE TABLE public."__EFMigrationsHistory" (
    "MigrationId" character varying(150) NOT NULL,
    "ProductVersion" character varying(32) NOT NULL
);


ALTER TABLE public."__EFMigrationsHistory" OWNER TO chatroom1;

--
-- TOC entry 4015 (class 0 OID 16411)
-- Dependencies: 213
-- Data for Name: ChatRooms; Type: TABLE DATA; Schema: public; Owner: chatroom1
--

COPY public."ChatRooms" ("Id", "Name", "CreatedById", "CreationTime") FROM stdin;
2	DevOps	3	2022-02-14 23:43:51.518482+01
1	CSharp	2	2022-02-14 23:34:36.32096+01
3	Games	4	2022-02-15 00:12:02.477466+01
4	Test Room	1	2022-02-17 11:10:53.322789+01
\.


--
-- TOC entry 4021 (class 0 OID 16640)
-- Dependencies: 219
-- Data for Name: Comments; Type: TABLE DATA; Schema: public; Owner: chatroom1
--

COPY public."Comments" ("Id", "CommentString", "ChatRoomId", "PostingUser", "PostEvent") FROM stdin;
2	This is my first post here.	2	2	10
3	This is my second post here.	2	2	11
4	Hi Kate how are you?	2	3	14
5	Hi Kate, are you here?	2	3	16
7	I have to go now. Hope to speak to you soon.	2	3	18
\.


--
-- TOC entry 4017 (class 0 OID 16419)
-- Dependencies: 215
-- Data for Name: RoomEventTypes; Type: TABLE DATA; Schema: public; Owner: chatroom1
--

COPY public."RoomEventTypes" ("Id", "Name") FROM stdin;
1	enter-the-room
2	leave-the-room
3	comment
4	high-five-another-user
\.


--
-- TOC entry 4018 (class 0 OID 16440)
-- Dependencies: 216
-- Data for Name: RoomEvents; Type: TABLE DATA; Schema: public; Owner: chatroom1
--

COPY public."RoomEvents" ("EventTypeId", "UserId", "TargetUserId", "ChatRoomId", "Id", "EventTime") FROM stdin;
1	1	\N	2	7	2022-02-15 19:14:09.879376+01
2	1	\N	2	8	2022-02-15 19:15:36.601485+01
1	2	\N	2	9	2022-02-15 19:16:03.492801+01
3	2	\N	2	10	2022-02-15 19:16:22.41598+01
3	2	\N	2	11	2022-02-15 19:25:14.090611+01
4	2	1	2	12	2022-02-15 19:26:11.867423+01
1	3	\N	2	13	2022-02-15 19:47:36.020287+01
3	3	\N	2	14	2022-02-15 19:48:18.2767+01
4	2	3	2	15	2022-02-15 19:49:12.647301+01
3	3	\N	2	16	2022-02-15 19:51:27.214666+01
3	3	\N	2	18	2022-02-15 20:25:53.106056+01
4	3	1	2	19	2022-02-15 21:27:41.885236+01
4	2	1	2	20	2022-02-15 21:27:48.34226+01
4	2	3	2	21	2022-02-15 21:28:22.620375+01
1	1	\N	2	22	2022-02-15 21:28:51.142805+01
4	3	2	2	23	2022-02-15 21:30:05.469593+01
1	5	\N	4	24	2022-02-17 11:30:10.742981+01
\.


--
-- TOC entry 4013 (class 0 OID 16403)
-- Dependencies: 211
-- Data for Name: Users; Type: TABLE DATA; Schema: public; Owner: chatroom1
--

COPY public."Users" ("Id", "NickNAme", "FirstName", "LastName") FROM stdin;
1	Test_1	Jack	Test
2	TestJ	TestJ	Joe
3	TestM	TestM	Marie
4	DavidNiack	TestD	David
5	Nagyi	Gabor	Nagy
\.


--
-- TOC entry 4011 (class 0 OID 16397)
-- Dependencies: 209
-- Data for Name: __EFMigrationsHistory; Type: TABLE DATA; Schema: public; Owner: chatroom1
--

COPY public."__EFMigrationsHistory" ("MigrationId", "ProductVersion") FROM stdin;
20220213000924_InitializeDb	6.0.2
20220213183315_InitialChatDb	6.0.2
20220215181223_ForeignKeyUpdates	6.0.2
20220215191433_UpdatColumnNames	6.0.2
20220216175554_HourlyEvenFunction	6.0.2
\.


--
-- TOC entry 4028 (class 0 OID 0)
-- Dependencies: 210
-- Name: Blogs_BlogId_seq; Type: SEQUENCE SET; Schema: public; Owner: chatroom1
--

SELECT pg_catalog.setval('public."Blogs_BlogId_seq"', 5, true);


--
-- TOC entry 4029 (class 0 OID 0)
-- Dependencies: 212
-- Name: ChatRooms_ChatRoomId_seq; Type: SEQUENCE SET; Schema: public; Owner: chatroom1
--

SELECT pg_catalog.setval('public."ChatRooms_ChatRoomId_seq"', 4, true);


--
-- TOC entry 4030 (class 0 OID 0)
-- Dependencies: 218
-- Name: Comments_Id_seq; Type: SEQUENCE SET; Schema: public; Owner: chatroom1
--

SELECT pg_catalog.setval('public."Comments_Id_seq"', 7, true);


--
-- TOC entry 4031 (class 0 OID 0)
-- Dependencies: 214
-- Name: RoomEventTypes_RoomEventTypeId_seq; Type: SEQUENCE SET; Schema: public; Owner: chatroom1
--

SELECT pg_catalog.setval('public."RoomEventTypes_RoomEventTypeId_seq"', 1, false);


--
-- TOC entry 4032 (class 0 OID 0)
-- Dependencies: 217
-- Name: RoomEvents_Id_seq; Type: SEQUENCE SET; Schema: public; Owner: chatroom1
--

SELECT pg_catalog.setval('public."RoomEvents_Id_seq"', 24, true);


--
-- TOC entry 3850 (class 2606 OID 16417)
-- Name: ChatRooms PK_ChatRooms; Type: CONSTRAINT; Schema: public; Owner: chatroom1
--

ALTER TABLE ONLY public."ChatRooms"
    ADD CONSTRAINT "PK_ChatRooms" PRIMARY KEY ("Id");


--
-- TOC entry 3863 (class 2606 OID 16646)
-- Name: Comments PK_Comments; Type: CONSTRAINT; Schema: public; Owner: chatroom1
--

ALTER TABLE ONLY public."Comments"
    ADD CONSTRAINT "PK_Comments" PRIMARY KEY ("Id");


--
-- TOC entry 3852 (class 2606 OID 16425)
-- Name: RoomEventTypes PK_RoomEventTypes; Type: CONSTRAINT; Schema: public; Owner: chatroom1
--

ALTER TABLE ONLY public."RoomEventTypes"
    ADD CONSTRAINT "PK_RoomEventTypes" PRIMARY KEY ("Id");


--
-- TOC entry 3858 (class 2606 OID 16588)
-- Name: RoomEvents PK_RoomEvents; Type: CONSTRAINT; Schema: public; Owner: chatroom1
--

ALTER TABLE ONLY public."RoomEvents"
    ADD CONSTRAINT "PK_RoomEvents" PRIMARY KEY ("Id");


--
-- TOC entry 3847 (class 2606 OID 16590)
-- Name: Users PK_Users; Type: CONSTRAINT; Schema: public; Owner: chatroom1
--

ALTER TABLE ONLY public."Users"
    ADD CONSTRAINT "PK_Users" PRIMARY KEY ("Id");


--
-- TOC entry 3845 (class 2606 OID 16401)
-- Name: __EFMigrationsHistory PK___EFMigrationsHistory; Type: CONSTRAINT; Schema: public; Owner: chatroom1
--

ALTER TABLE ONLY public."__EFMigrationsHistory"
    ADD CONSTRAINT "PK___EFMigrationsHistory" PRIMARY KEY ("MigrationId");


--
-- TOC entry 3848 (class 1259 OID 16592)
-- Name: IX_ChatRooms_CreatedById; Type: INDEX; Schema: public; Owner: chatroom1
--

CREATE INDEX "IX_ChatRooms_CreatedById" ON public."ChatRooms" USING btree ("CreatedById");


--
-- TOC entry 3859 (class 1259 OID 16662)
-- Name: IX_Comments_ChatRoomId; Type: INDEX; Schema: public; Owner: chatroom1
--

CREATE INDEX "IX_Comments_ChatRoomId" ON public."Comments" USING btree ("ChatRoomId");


--
-- TOC entry 3860 (class 1259 OID 16663)
-- Name: IX_Comments_PostEvent; Type: INDEX; Schema: public; Owner: chatroom1
--

CREATE INDEX "IX_Comments_PostEvent" ON public."Comments" USING btree ("PostEvent");


--
-- TOC entry 3861 (class 1259 OID 16664)
-- Name: IX_Comments_PostingUser; Type: INDEX; Schema: public; Owner: chatroom1
--

CREATE INDEX "IX_Comments_PostingUser" ON public."Comments" USING btree ("PostingUser");


--
-- TOC entry 3853 (class 1259 OID 16461)
-- Name: IX_RoomEvents_ChatRoomId; Type: INDEX; Schema: public; Owner: chatroom1
--

CREATE INDEX "IX_RoomEvents_ChatRoomId" ON public."RoomEvents" USING btree ("ChatRoomId");


--
-- TOC entry 3854 (class 1259 OID 16593)
-- Name: IX_RoomEvents_EventTypeId; Type: INDEX; Schema: public; Owner: chatroom1
--

CREATE INDEX "IX_RoomEvents_EventTypeId" ON public."RoomEvents" USING btree ("EventTypeId");


--
-- TOC entry 3855 (class 1259 OID 16462)
-- Name: IX_RoomEvents_TargetUserId; Type: INDEX; Schema: public; Owner: chatroom1
--

CREATE INDEX "IX_RoomEvents_TargetUserId" ON public."RoomEvents" USING btree ("TargetUserId");


--
-- TOC entry 3856 (class 1259 OID 16463)
-- Name: IX_RoomEvents_UserId; Type: INDEX; Schema: public; Owner: chatroom1
--

CREATE INDEX "IX_RoomEvents_UserId" ON public."RoomEvents" USING btree ("UserId");


--
-- TOC entry 3864 (class 2606 OID 16594)
-- Name: ChatRooms FK_ChatRooms_Users_CreatedById; Type: FK CONSTRAINT; Schema: public; Owner: chatroom1
--

ALTER TABLE ONLY public."ChatRooms"
    ADD CONSTRAINT "FK_ChatRooms_Users_CreatedById" FOREIGN KEY ("CreatedById") REFERENCES public."Users"("Id") ON DELETE CASCADE;


--
-- TOC entry 3869 (class 2606 OID 16647)
-- Name: Comments FK_Comments_ChatRooms_ChatRoomId; Type: FK CONSTRAINT; Schema: public; Owner: chatroom1
--

ALTER TABLE ONLY public."Comments"
    ADD CONSTRAINT "FK_Comments_ChatRooms_ChatRoomId" FOREIGN KEY ("ChatRoomId") REFERENCES public."ChatRooms"("Id") ON DELETE CASCADE;


--
-- TOC entry 3870 (class 2606 OID 16652)
-- Name: Comments FK_Comments_RoomEvents_PostEvent; Type: FK CONSTRAINT; Schema: public; Owner: chatroom1
--

ALTER TABLE ONLY public."Comments"
    ADD CONSTRAINT "FK_Comments_RoomEvents_PostEvent" FOREIGN KEY ("PostEvent") REFERENCES public."RoomEvents"("Id") ON DELETE CASCADE;


--
-- TOC entry 3871 (class 2606 OID 16657)
-- Name: Comments FK_Comments_Users_PostingUser; Type: FK CONSTRAINT; Schema: public; Owner: chatroom1
--

ALTER TABLE ONLY public."Comments"
    ADD CONSTRAINT "FK_Comments_Users_PostingUser" FOREIGN KEY ("PostingUser") REFERENCES public."Users"("Id") ON DELETE CASCADE;


--
-- TOC entry 3865 (class 2606 OID 16609)
-- Name: RoomEvents FK_RoomEvents_ChatRooms_ChatRoomId; Type: FK CONSTRAINT; Schema: public; Owner: chatroom1
--

ALTER TABLE ONLY public."RoomEvents"
    ADD CONSTRAINT "FK_RoomEvents_ChatRooms_ChatRoomId" FOREIGN KEY ("ChatRoomId") REFERENCES public."ChatRooms"("Id") ON DELETE CASCADE;


--
-- TOC entry 3866 (class 2606 OID 16614)
-- Name: RoomEvents FK_RoomEvents_RoomEventTypes_EventTypeId; Type: FK CONSTRAINT; Schema: public; Owner: chatroom1
--

ALTER TABLE ONLY public."RoomEvents"
    ADD CONSTRAINT "FK_RoomEvents_RoomEventTypes_EventTypeId" FOREIGN KEY ("EventTypeId") REFERENCES public."RoomEventTypes"("Id") ON DELETE CASCADE;


--
-- TOC entry 3868 (class 2606 OID 16634)
-- Name: RoomEvents FK_RoomEvents_Users_TargetUserId; Type: FK CONSTRAINT; Schema: public; Owner: chatroom1
--

ALTER TABLE ONLY public."RoomEvents"
    ADD CONSTRAINT "FK_RoomEvents_Users_TargetUserId" FOREIGN KEY ("TargetUserId") REFERENCES public."Users"("Id");


--
-- TOC entry 3867 (class 2606 OID 16624)
-- Name: RoomEvents FK_RoomEvents_Users_UserId; Type: FK CONSTRAINT; Schema: public; Owner: chatroom1
--

ALTER TABLE ONLY public."RoomEvents"
    ADD CONSTRAINT "FK_RoomEvents_Users_UserId" FOREIGN KEY ("UserId") REFERENCES public."Users"("Id") ON DELETE CASCADE;


-- Completed on 2022-02-17 12:27:55 CET

--
-- PostgreSQL database dump complete
--

